
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>fluid/update_velocity.c &#8212; Simple Navier-Stokes Solver 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script>window.MathJax = {"TeX": {"Macros": {"der": ["{\\frac{\\partial #1}{\\partial #2}}", 2], "dder": ["{\\frac{\\delta #1}{\\delta #2}}", 2], "mst": ["{\\gamma^{#1 #2}}", 2], "gx": ["{\\xi}"], "gy": ["{\\eta}"], "ux": ["{u_x}"], "uy": ["{u_y}"], "intrp": ["{\\overline{#1}^{#2}}", 2], "diffe": ["{\\delta_{#2} {#1}}", 2], "vat": ["{\\left. {#1} \\right|_{#2}}", 2], "ave": ["{\\left\\langle {#1} \\right\\rangle_{#2}}", 2], "pimm": ["i-1           "], "pim": ["i-\\frac{1}{2}"], "pic": ["i             "], "pip": ["i+\\frac{1}{2}"], "pipp": ["i+1           "], "pjmm": ["j-1           "], "pjm": ["j-\\frac{1}{2}"], "pjc": ["j             "], "pjp": ["j+\\frac{1}{2}"], "pjpp": ["j+1           "], "ximm": ["i-\\frac{1}{2}"], "xim": ["i             "], "xic": ["i+\\frac{1}{2}"], "xip": ["i+1           "], "xipp": ["i+\\frac{3}{2}"], "xjmm": ["j-1           "], "xjm": ["j-\\frac{1}{2}"], "xjc": ["j             "], "xjp": ["j+\\frac{1}{2}"], "xjpp": ["j+1           "], "yimm": ["i-1           "], "yim": ["i-\\frac{1}{2}"], "yic": ["i             "], "yip": ["i+\\frac{1}{2}"], "yipp": ["i+1           "], "yjmm": ["j-\\frac{1}{2}"], "yjm": ["j             "], "yjc": ["j+\\frac{1}{2}"], "yjp": ["j+1           "], "yjpp": ["j+\\frac{3}{2}"], "dintrpa": ["{\\overline{#1}^{#2}}", 2], "dintrpv": ["{\\widehat {#1}^{#2}}", 2], "dintrpu": ["{\\widetilde {#1}^{#2}}", 2]}}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="linalg.c" href="../linalg.html" />
    <link rel="prev" title="fluid/update_pressure.c" href="update_pressure.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Simple Navier-Stokes Solver</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=NaokiHori&repo=SimpleNavierStokesSolver&type=true&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governing_equations/index.html">Governing equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../numerical_method/index.html">Numerical method</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Implementation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../analyses.html">analyses.c</a></li>
<li class="toctree-l2"><a class="reference internal" href="../common.html">common.c</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fileio/main.html">fileio.c</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">fluid/</a></li>
<li class="toctree-l2"><a class="reference internal" href="../linalg.html">linalg.c</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging.html">logging.c</a></li>
<li class="toctree-l2"><a class="reference internal" href="../main.html">main.c</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parallel/index.html">parallel/</a></li>
<li class="toctree-l2"><a class="reference internal" href="../param/index.html">param/</a></li>
<li class="toctree-l2"><a class="reference internal" href="../save.html">save.c</a></li>
<li class="toctree-l2"><a class="reference internal" href="../simple_npyio.html">simple_npy_io.c</a></li>
<li class="toctree-l2"><a class="reference internal" href="../statistics/index.html">statistics/</a></li>
<li class="toctree-l2"><a class="reference internal" href="../temperature/index.html">temperature/</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Implementation</a><ul>
  <li><a href="index.html">fluid/</a><ul>
      <li>Previous: <a href="update_pressure.html" title="previous chapter">fluid/update_pressure.c</a></li>
      <li>Next: <a href="../linalg.html" title="next chapter">linalg.c</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <span class="target" id="fluid-update-velocity"></span><section id="id1">
<h1><a class="reference external" href="https://github.com/NaokiHori/SimpleNavierStokesSolver/blob/main/src/fluid/update_velocity.c">fluid/update_velocity.c</a><a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h1>
<p>Update velocity from <span class="math notranslate nohighlight">\(u_i^k\)</span> to <span class="math notranslate nohighlight">\(u_i^*\)</span>, which does not necessarily satisfy divergence-free condition.</p>
<p>See <a class="reference internal" href="../../numerical_method/temporal_discretisation/index.html#temporal-discretisation"><span class="std std-ref">the temporal discretisation</span></a> and <a class="reference internal" href="../../numerical_method/spatial_discretisation/index.html#spatial-discretisation"><span class="std std-ref">the spatial discretisation</span></a> for details.</p>
<section id="id2">
<h2>fluid_update_velocity<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<section id="definition">
<h3>Definition<a class="headerlink" href="#definition" title="Permalink to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">fluid_update_velocity</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">param_t</span><span class="w"> </span><span class="o">*</span><span class="n">param</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">parallel_t</span><span class="w"> </span><span class="o">*</span><span class="n">parallel</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fluid_t</span><span class="w"> </span><span class="o">*</span><span class="n">fluid</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">temperature_t</span><span class="w"> </span><span class="o">*</span><span class="n">temperature</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>intent</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>param</p></td>
<td><p>in</p></td>
<td><p>general parameters</p></td>
</tr>
<tr class="row-odd"><td><p>parallel</p></td>
<td><p>in</p></td>
<td><p>MPI parameters</p></td>
</tr>
<tr class="row-even"><td><p>fluid</p></td>
<td><p>in/out</p></td>
<td><p>pressure (in), velocity (in/out)</p></td>
</tr>
<tr class="row-odd"><td><p>temperature</p></td>
<td><p>in</p></td>
<td><p>thermal forcing term</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h3>Description<a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h3>
<p>Now we try to update the velocity field of the previous Runge-Kutta step <span class="math notranslate nohighlight">\(k\)</span>: <span class="math notranslate nohighlight">\(u_i^k\)</span> to tentative values <span class="math notranslate nohighlight">\(u_i^*\)</span> using <a class="reference internal" href="../../numerical_method/temporal_discretisation/smac_method.html#smac-method"><span class="std std-ref">the SMAC method</span></a>.</p>
<p>Source terms in the right-hand-side (<span class="math notranslate nohighlight">\(A_i^k\)</span>, <span class="math notranslate nohighlight">\(D_i^k\)</span>, and <span class="math notranslate nohighlight">\(P_i^k\)</span>) are computed in two directions <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">492</span><span class="w">  </span><span class="n">compute_src_ux</span><span class="p">(</span><span class="n">param</span><span class="p">,</span><span class="w"> </span><span class="n">parallel</span><span class="p">,</span><span class="w"> </span><span class="n">fluid</span><span class="p">,</span><span class="w"> </span><span class="n">temperature</span><span class="p">);</span><span class="w"></span>
<span class="linenos">493</span><span class="w">  </span><span class="n">compute_src_uy</span><span class="p">(</span><span class="n">param</span><span class="p">,</span><span class="w"> </span><span class="n">parallel</span><span class="p">,</span><span class="w"> </span><span class="n">fluid</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>which are followed by</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">495</span><span class="w">  </span><span class="n">update_ux</span><span class="p">(</span><span class="n">param</span><span class="p">,</span><span class="w"> </span><span class="n">parallel</span><span class="p">,</span><span class="w"> </span><span class="n">rkstep</span><span class="p">,</span><span class="w"> </span><span class="n">fluid</span><span class="p">);</span><span class="w"></span>
<span class="linenos">496</span><span class="w">  </span><span class="n">update_uy</span><span class="p">(</span><span class="n">param</span><span class="p">,</span><span class="w"> </span><span class="n">parallel</span><span class="p">,</span><span class="w"> </span><span class="n">rkstep</span><span class="p">,</span><span class="w"> </span><span class="n">fluid</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>where the velocities are updated.</p>
<p>For more information about these 4 functions, see below.</p>
</section>
</section>
<section id="compute-src-ux">
<h2>compute_src_ux<a class="headerlink" href="#compute-src-ux" title="Permalink to this heading">¶</a></h2>
<section id="id3">
<h3>Definition<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">compute_src_ux</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">param_t</span><span class="w"> </span><span class="o">*</span><span class="n">param</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">parallel_t</span><span class="w"> </span><span class="o">*</span><span class="n">parallel</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fluid_t</span><span class="w"> </span><span class="o">*</span><span class="n">fluid</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">temperature_t</span><span class="w"> </span><span class="o">*</span><span class="n">temperature</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>intent</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>param</p></td>
<td><p>in</p></td>
<td><p>general parameters</p></td>
</tr>
<tr class="row-odd"><td><p>parallel</p></td>
<td><p>in</p></td>
<td><p>MPI parameters</p></td>
</tr>
<tr class="row-even"><td><p>fluid</p></td>
<td><p>in/out</p></td>
<td><p>pressure, velocity (in), source terms (in/out)</p></td>
</tr>
<tr class="row-odd"><td><p>temperature</p></td>
<td><p>in</p></td>
<td><p>thermal forcing term</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id4">
<h3>Description<a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<p>Compute source terms of the Runge-Kutta integration (<span class="math notranslate nohighlight">\(A_x^k\)</span>, <span class="math notranslate nohighlight">\(D_x^k\)</span>, <span class="math notranslate nohighlight">\(P_x^k\)</span>) of the momentum equation in <span class="math notranslate nohighlight">\(x\)</span> direction.</p>
<p>First of all, <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuxa</span><span class="w"></span></code> (the last character <strong>a</strong> implies <span class="math notranslate nohighlight">\(\alpha\)</span>), which contains the information of the previous Runge-Kutta step, is copied to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuxb</span><span class="w"></span></code> (the last character <strong>b</strong> implies <span class="math notranslate nohighlight">\(\beta\)</span>), so that new values can be assigned to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuxa</span><span class="w"></span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">32</span><span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">srcuxb</span><span class="p">,</span><span class="w"> </span><span class="n">srcuxa</span><span class="p">,</span><span class="w"> </span><span class="n">SRCUXA_MEMSIZE</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Then, all source terms are evaluated at each location where <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">ux</span><span class="w"></span></code> is defined.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The spatial discretisations and their derivations are extensively discussed in the section <a class="reference internal" href="../../numerical_method/spatial_discretisation/discrete_governing_equations/momentum_balance_and_quadratic_quantity.html#momentum-balance"><span class="std std-ref">“momentum balance and quadratic quantity”</span></a>.</p>
<p>Hereafter, superscript <span class="math notranslate nohighlight">\(k\)</span>, which denotes Runge-Kutta step and should be on all <span class="math notranslate nohighlight">\(\ux\)</span> and <span class="math notranslate nohighlight">\(\uy\)</span>, are dropped for notational simplicity.</p>
</div>
<ol class="arabic" start="0">
<li><p>Prerequisite: velocity-gradient tensor <span class="math notranslate nohighlight">\(\partial_j \ux\)</span></p>
<details>
<summary>
Details</summary><p>Discrete velocity-gradient tensor</p>
<div class="math notranslate nohighlight">
\[L_{xj}
\equiv
\dder{\ux}{x_j}\]</div>
<p>appears both in the advective and diffusive terms.
<span class="math notranslate nohighlight">\(L_{xx}\)</span> are requested at the neighbouring cell centers:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\vat{
   \dder{\ux}{x}
}{\xim, \xjc}
&amp; =
\frac{
   \vat{
      \ux
   }{\xic,  \xjc}
   -
   \vat{
      \ux
   }{\ximm, \xjc}
}{\vat{\Delta x}{\xim}}, \\
\vat{
   \dder{\ux}{x}
}{\xip, \xjc}
&amp; =
\frac{
   \vat{
      \ux
   }{\xipp, \xjc}
   -
   \vat{
      \ux
   }{\xic,  \xjc}
}{\vat{\Delta x}{\xip}},\end{split}\]</div>
<p>which are implemented as</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">37</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">duxdx_xm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">)</span><span class="o">+</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">))</span><span class="o">/</span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">38</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">duxdx_xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">)</span><span class="o">+</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">))</span><span class="o">/</span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_lxx.pdf"><img alt="../../_images/update_velocity_lxx.pdf" src="../../_images/update_velocity_lxx.pdf" style="width: 800px;" /></a>
<p><span class="math notranslate nohighlight">\(L_{xy}\)</span> are needed at the neighbouring cell corners:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\vat{
   \dder{\ux}{y}
}{\xic, \xjm}
&amp; =
\frac{
   \vat{
      \ux
   }{\xic, \xjc }
   -
   \vat{
      \ux
   }{\xic, \xjmm}
}{\Delta y}, \\
\vat{
   \dder{\ux}{y}
}{\xic, \xjp}
&amp; =
\frac{
   \vat{
      \ux
   }{\xic, \xjpp}
   -
   \vat{
      \ux
   }{\xic, \xjc }
}{\Delta y},\end{split}\]</div>
<p>which are implemented as</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">40</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">duxdy_ym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="mi">-1</span><span class="p">)</span><span class="o">+</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">))</span><span class="o">/</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="linenos">41</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">duxdy_yp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">)</span><span class="o">+</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_lxy.pdf"><img alt="../../_images/update_velocity_lxy.pdf" src="../../_images/update_velocity_lxy.pdf" style="width: 800px;" /></a>
</details></li>
<li><p>Advective terms (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv1</span><span class="w"></span></code>, <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv2</span><span class="w"></span></code>)</p>
<ol class="arabic">
<li><p><code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv1</span><span class="w"></span></code>: Advection of <span class="math notranslate nohighlight">\(\ux\)</span> by <span class="math notranslate nohighlight">\(\ux\)</span></p>
<div class="math notranslate nohighlight">
\[-
\vat{
   \dintrpv{
      \dintrpa{\ux}{x}
      \dder{\ux}{x}
   }{x}
}{\xic, \xjc}\]</div>
<details>
<summary>
Details</summary><p>Discrete derivatives are given above.
<em>Overline</em> symbol denotes arithmetic average, while the <em>widehat</em> symbol is used to indicate the volume interpolation:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\vat{C}{\xim}
&amp; =
\frac{\Delta x_{\xim}}{2 \Delta x_{\xic}}, \\
\vat{C}{\xip}
&amp; =
\frac{\Delta x_{\xip}}{2 \Delta x_{\xic}}.\end{split}\]</div>
<p>The implementation leads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">44</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">adv1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">45</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">46</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">c_xm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="linenos">47</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">c_xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="linenos">48</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">ux_xm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">49</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">ux_xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">50</span><span class="w">        </span><span class="n">adv1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">51</span><span class="w">          </span><span class="o">-</span><span class="n">c_xm</span><span class="o">*</span><span class="n">ux_xm</span><span class="o">*</span><span class="n">duxdx_xm</span><span class="w"></span>
<span class="linenos">52</span><span class="w">          </span><span class="o">-</span><span class="n">c_xp</span><span class="o">*</span><span class="n">ux_xp</span><span class="o">*</span><span class="n">duxdx_xp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">53</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_adv_x_x.pdf"><img alt="../../_images/update_velocity_adv_x_x.pdf" src="../../_images/update_velocity_adv_x_x.pdf" style="width: 800px;" /></a>
</details></li>
<li><p><code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv2</span><span class="w"></span></code>: Advection of <span class="math notranslate nohighlight">\(\ux\)</span> by <span class="math notranslate nohighlight">\(\uy\)</span></p>
<div class="math notranslate nohighlight">
\[-
\vat{
   \dintrpa{
      \dintrpv{\uy}{x}
      \dder{\ux}{y}
   }{y}
}{\xic, \xjc}\]</div>
<details>
<summary>
Details</summary><p>Discrete derivatives are given above.
<em>Overline</em> symbol denotes arithmetic average, while the <em>widehat</em> symbol is used to indicate the volume interpolation:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\vat{C}{\xim}
&amp; =
\frac{\Delta x_{\xim}}{2 \Delta x_{\xic}}, \\
\vat{C}{\xip}
&amp; =
\frac{\Delta x_{\xip}}{2 \Delta x_{\xic}}.\end{split}\]</div>
<p>The implementation leads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">55</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">adv2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">56</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">57</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">c_xm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="linenos">58</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">c_xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="linenos">59</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">uy_ym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c_xm</span><span class="o">*</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">)</span><span class="o">+</span><span class="n">c_xp</span><span class="o">*</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">60</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">uy_yp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c_xm</span><span class="o">*</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">c_xp</span><span class="o">*</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">61</span><span class="w">        </span><span class="n">adv2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">62</span><span class="w">          </span><span class="mf">-0.5</span><span class="o">*</span><span class="n">uy_ym</span><span class="o">*</span><span class="n">duxdy_ym</span><span class="w"></span>
<span class="linenos">63</span><span class="w">          </span><span class="mf">-0.5</span><span class="o">*</span><span class="n">uy_yp</span><span class="o">*</span><span class="n">duxdy_yp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">64</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_adv_x_y.pdf"><img alt="../../_images/update_velocity_adv_x_y.pdf" src="../../_images/update_velocity_adv_x_y.pdf" style="width: 800px;" /></a>
</details></li>
</ol>
</li>
<li><p>Diffusive terms (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">dif1</span><span class="w"></span></code>, <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">dif2</span><span class="w"></span></code>)</p>
<ol class="arabic">
<li><p><code class="code highlight c-lang c docutils literal highlight-c"><span class="n">dif1</span><span class="w"></span></code>: Diffusion of <span class="math notranslate nohighlight">\(\ux\)</span> in <span class="math notranslate nohighlight">\(x\)</span> direction</p>
<div class="math notranslate nohighlight">
\[\vat{
   \frac{\sqrt{Pr}}{\sqrt{Ra}} \dder{}{x} \left( \dder{\ux}{x} \right)
}{\xic, \xjc}\]</div>
<details>
<summary>
Details</summary><p>The implementation leads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">67</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">dif1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">68</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">69</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">prefactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">Pr</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ra</span><span class="p">);</span><span class="w"></span>
<span class="linenos">70</span><span class="w">        </span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefactor</span><span class="o">*</span><span class="p">(</span><span class="n">duxdx_xp</span><span class="o">-</span><span class="n">duxdx_xm</span><span class="p">)</span><span class="o">/</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">71</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_dif_x_x.pdf"><img alt="../../_images/update_velocity_dif_x_x.pdf" src="../../_images/update_velocity_dif_x_x.pdf" style="width: 800px;" /></a>
</details></li>
<li><p><code class="code highlight c-lang c docutils literal highlight-c"><span class="n">dif2</span><span class="w"></span></code>: Diffusion of <span class="math notranslate nohighlight">\(\ux\)</span> in <span class="math notranslate nohighlight">\(y\)</span> direction</p>
<div class="math notranslate nohighlight">
\[\vat{
   \frac{\sqrt{Pr}}{\sqrt{Ra}} \dder{}{y} \left( \dder{\ux}{y} \right)
}{\xic, \xjc}\]</div>
<details>
<summary>
Details</summary><p>The implementation leads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">73</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">dif2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">74</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">75</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">prefactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">Pr</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ra</span><span class="p">);</span><span class="w"></span>
<span class="linenos">76</span><span class="w">        </span><span class="n">dif2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefactor</span><span class="o">*</span><span class="p">(</span><span class="n">duxdy_yp</span><span class="o">-</span><span class="n">duxdy_ym</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="linenos">77</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_dif_x_y.pdf"><img alt="../../_images/update_velocity_dif_x_y.pdf" src="../../_images/update_velocity_dif_x_y.pdf" style="width: 800px;" /></a>
</details></li>
</ol>
</li>
<li><p>Pressure-gradient term (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">pre</span><span class="w"></span></code>)</p>
<div class="math notranslate nohighlight">
\[-
\vat{
   \dder{p}{x}
}{\xic, \xjc}\]</div>
<details>
<summary>
Details</summary><p>The implementation leads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">80</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">pre</span><span class="p">;</span><span class="w"></span>
<span class="linenos">81</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">82</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">p_xm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">P</span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">83</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">p_xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">P</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">84</span><span class="w">        </span><span class="n">pre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">p_xp</span><span class="o">-</span><span class="n">p_xm</span><span class="p">)</span><span class="o">/</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">85</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</details></li>
<li><p>Buoyancy term (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">tmp</span><span class="w"></span></code>)</p>
<div class="math notranslate nohighlight">
\[\vat{
   \dintrpa{T}{x}
}{\xic, \xjc}\]</div>
<details>
<summary>
Details</summary><div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>It is computed in <a class="reference internal" href="../temperature/force.html#temperature-force"><span class="std std-ref">src/temperature/force.c</span></a>, so that this forcing term can be easily switched off (c.f., <a class="reference internal" href="../param/index.html#param"><span class="std std-ref">param-&gt;with_thermal_forcing</span></a>).</p>
</div>
<p>The implementation leads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">88</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TEMPFORCEX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</details></li>
</ol>
<p>After all source terms are evaluated, they are assigned to the corresponding variable.</p>
<p>Terms which are treated explicitly are summed up to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuxa</span><span class="w"></span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">91</span><span class="w">      </span><span class="n">SRCUXA</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">92</span><span class="w">        </span><span class="o">+</span><span class="p">(</span><span class="n">adv1</span><span class="o">+</span><span class="n">adv2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">93</span><span class="w">        </span><span class="o">+</span><span class="p">(</span><span class="mf">1.-1.</span><span class="o">*</span><span class="n">implicitx</span><span class="p">)</span><span class="o">*</span><span class="n">dif1</span><span class="w"></span>
<span class="linenos">94</span><span class="w">        </span><span class="o">+</span><span class="p">(</span><span class="mf">1.-1.</span><span class="o">*</span><span class="n">implicity</span><span class="p">)</span><span class="o">*</span><span class="n">dif2</span><span class="w"></span>
<span class="linenos">95</span><span class="w">        </span><span class="o">+</span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Advective terms (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv1</span><span class="w"></span></code>, <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv2</span><span class="w"></span></code>) and buoyancy term (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">tmp</span><span class="w"></span></code>) are involved since they are always treated explicitly.</p>
<p>Diffusive terms are summed up here when treated explicitly (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">implicitx</span><span class="w"></span></code> or <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">implicity</span><span class="w"></span></code> is <span class="math notranslate nohighlight">\(0\)</span>), while are neglected here when treated implicitly (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">implicitx</span><span class="w"></span></code> or <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">implicity</span><span class="w"></span></code> is <span class="math notranslate nohighlight">\(1\)</span>).</p>
<p>Instead, they are summed up to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuxg</span><span class="w"></span></code> when treated implicitly:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 97</span><span class="w">      </span><span class="n">SRCUXG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos"> 98</span><span class="w">        </span><span class="o">+</span><span class="p">(</span><span class="w">  </span><span class="o">+</span><span class="mf">1.</span><span class="o">*</span><span class="n">implicitx</span><span class="p">)</span><span class="o">*</span><span class="n">dif1</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">        </span><span class="o">+</span><span class="p">(</span><span class="w">  </span><span class="o">+</span><span class="mf">1.</span><span class="o">*</span><span class="n">implicity</span><span class="p">)</span><span class="o">*</span><span class="n">dif2</span><span class="w"></span>
<span class="linenos">100</span><span class="w">        </span><span class="o">+</span><span class="n">pre</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Pressure gradient term (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">pre</span><span class="w"></span></code>) is always treated implicitly.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The inner loop (with respect to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">i</span><span class="w"></span></code>, <span class="math notranslate nohighlight">\(x\)</span> locations) does not contain <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="w"></span></code> and <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">i</span><span class="o">=</span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="w"></span></code>, which are on the boundaries and the values are known a priori as boundary conditions.
In particular, <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">UX</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UX</span><span class="p">(</span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span></code> since this project assumes impermeable walls.</p>
</div>
</section>
</section>
<section id="compute-src-uy">
<h2>compute_src_uy<a class="headerlink" href="#compute-src-uy" title="Permalink to this heading">¶</a></h2>
<section id="id5">
<h3>Definition<a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">compute_src_uy</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">param_t</span><span class="w"> </span><span class="o">*</span><span class="n">param</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">parallel_t</span><span class="w"> </span><span class="o">*</span><span class="n">parallel</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fluid_t</span><span class="w"> </span><span class="o">*</span><span class="n">fluid</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>intent</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>param</p></td>
<td><p>in</p></td>
<td><p>general parameters</p></td>
</tr>
<tr class="row-odd"><td><p>parallel</p></td>
<td><p>in</p></td>
<td><p>MPI parameters</p></td>
</tr>
<tr class="row-even"><td><p>fluid</p></td>
<td><p>in/out</p></td>
<td><p>pressure, velocity (in), source terms (in/out)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id6">
<h3>Description<a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h3>
<p>Compute source terms of the Runge-Kutta integration (<span class="math notranslate nohighlight">\(A_y^k\)</span>, <span class="math notranslate nohighlight">\(D_y^k\)</span>, <span class="math notranslate nohighlight">\(P_y^k\)</span>) of the momentum equation in <span class="math notranslate nohighlight">\(y\)</span> direction.</p>
<p>First of all, <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuya</span><span class="w"></span></code> (the last character <strong>a</strong> implies <span class="math notranslate nohighlight">\(\alpha\)</span>), which contains the information of the previous Runge-Kutta step, is copied to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuyb</span><span class="w"></span></code> (the last character <strong>b</strong> implies <span class="math notranslate nohighlight">\(\beta\)</span>), so that new values can be assigned to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuya</span><span class="w"></span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">126</span><span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">srcuyb</span><span class="p">,</span><span class="w"> </span><span class="n">srcuya</span><span class="p">,</span><span class="w"> </span><span class="n">SRCUYA_MEMSIZE</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Then, all source terms are evaluated at each location where <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">uy</span><span class="w"></span></code> is defined.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The spatial discretisations and their derivations are extensively discussed in the section <a class="reference internal" href="../../numerical_method/spatial_discretisation/discrete_governing_equations/momentum_balance_and_quadratic_quantity.html#momentum-balance"><span class="std std-ref">“momentum balance and quadratic quantity”</span></a>.</p>
<p>Hereafter, superscript <span class="math notranslate nohighlight">\(k\)</span>, which denotes Runge-Kutta step and should be on all <span class="math notranslate nohighlight">\(\ux\)</span> and <span class="math notranslate nohighlight">\(\uy\)</span>, are dropped for notational simplicity.</p>
</div>
<ol class="arabic" start="0">
<li><p>Prerequisite: velocity-gradient tensor <span class="math notranslate nohighlight">\(\partial_j \uy\)</span></p>
<details>
<summary>
Details</summary><p>Discrete velocity-gradient tensor</p>
<div class="math notranslate nohighlight">
\[L_{yj}
\equiv
\dder{\uy}{x_j}\]</div>
<p>appears both in the advective and diffusive terms.
<span class="math notranslate nohighlight">\(L_{yx}\)</span> are requested at the neighbouring cell corners:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\vat{
   \dder{\uy}{x}
}{\yim, \yjc}
&amp; =
\frac{
   \vat{
      \uy
   }{\yic,  \yjc}
   -
   \vat{
      \uy
   }{\yimm, \yjc}
}{\vat{\Delta x}{\yim}}, \\
\vat{
   \dder{\uy}{x}
}{\yip, \yjc}
&amp; =
\frac{
   \vat{
      \uy
   }{\yipp, \yjc}
   -
   \vat{
      \uy
   }{\yic,  \yjc}
}{\vat{\Delta x}{\yip}},\end{split}\]</div>
<p>which are implemented as</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">131</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">duydx_xm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">)</span><span class="o">+</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">))</span><span class="o">/</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">132</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">duydx_xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">)</span><span class="o">+</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">))</span><span class="o">/</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_lyx.pdf"><img alt="../../_images/update_velocity_lyx.pdf" src="../../_images/update_velocity_lyx.pdf" style="width: 800px;" /></a>
<p><span class="math notranslate nohighlight">\(L_{yy}\)</span> are needed at the neighbouring cell centers:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\vat{
   \dder{\uy}{y}
}{\yic, \yjm}
&amp; =
\frac{
   \vat{
      \uy
   }{\yic, \yjc }
   -
   \vat{
      \uy
   }{\yic, \yjmm}
}{\Delta y}, \\
\vat{
   \dder{\uy}{y}
}{\yic, \yjp}
&amp; =
\frac{
   \vat{
      \uy
   }{\yic, \yjpp}
   -
   \vat{
      \uy
   }{\yic, \yjc }
}{\Delta y}.\end{split}\]</div>
<p>which are implemented as</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">134</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">duydy_ym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="mi">-1</span><span class="p">)</span><span class="o">+</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">))</span><span class="o">/</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="linenos">135</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">duydy_yp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">)</span><span class="o">+</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_lyy.pdf"><img alt="../../_images/update_velocity_lyy.pdf" src="../../_images/update_velocity_lyy.pdf" style="width: 800px;" /></a>
</details></li>
<li><p>Advective terms (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv1</span><span class="w"></span></code>, <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv2</span><span class="w"></span></code>)</p>
<ol class="arabic">
<li><p><code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv1</span><span class="w"></span></code>: Advection of <span class="math notranslate nohighlight">\(\uy\)</span> by <span class="math notranslate nohighlight">\(\ux\)</span></p>
<div class="math notranslate nohighlight">
\[-
\vat{
   \dintrpv{
      \dintrpa{\ux}{y}
      \dder{\uy}{x}
   }{x}
}{\yic, \yjc}\]</div>
<details>
<summary>
Details</summary><p>Discrete derivatives are given above.
<em>Overline</em> symbol denotes arithmetic average, while the <em>widehat</em> symbol is used to indicate the volume interpolation:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\vat{C}{\yim}
&amp; =
\frac{\Delta x_{\yim}}{2 \Delta x_{\yic}}, \\
\vat{C}{\yip}
&amp; =
\frac{\Delta x_{\yip}}{2 \Delta x_{\yic}}.\end{split}\]</div>
<p>The implementation leads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">138</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">adv1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">139</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">140</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">c_xm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="linenos">141</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">c_xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="linenos">142</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">ux_xm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="mi">-1</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">143</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">ux_xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="mi">-1</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">144</span><span class="w">        </span><span class="n">adv1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">145</span><span class="w">          </span><span class="o">-</span><span class="n">c_xm</span><span class="o">*</span><span class="n">ux_xm</span><span class="o">*</span><span class="n">duydx_xm</span><span class="w"></span>
<span class="linenos">146</span><span class="w">          </span><span class="o">-</span><span class="n">c_xp</span><span class="o">*</span><span class="n">ux_xp</span><span class="o">*</span><span class="n">duydx_xp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">147</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_adv_y_x.pdf"><img alt="../../_images/update_velocity_adv_y_x.pdf" src="../../_images/update_velocity_adv_y_x.pdf" style="width: 800px;" /></a>
</details></li>
<li><p><code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv2</span><span class="w"></span></code>: Advection of <span class="math notranslate nohighlight">\(\uy\)</span> by <span class="math notranslate nohighlight">\(\uy\)</span></p>
<div class="math notranslate nohighlight">
\[-
\vat{
   \dintrpa{
      \dintrpa{\uy}{y}
      \dder{\uy}{y}
   }{y}
}{\yic, \yjc}\]</div>
<details>
<summary>
Details</summary><p>Discrete derivatives are given above.
<em>Overline</em> symbol denotes arithmetic average.</p>
<p>The implementation leads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">149</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">adv2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">150</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">151</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">uy_ym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="mi">-1</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">152</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">uy_yp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">153</span><span class="w">        </span><span class="n">adv2</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">154</span><span class="w">          </span><span class="mf">-0.5</span><span class="o">*</span><span class="n">uy_ym</span><span class="o">*</span><span class="n">duydy_ym</span><span class="w"></span>
<span class="linenos">155</span><span class="w">          </span><span class="mf">-0.5</span><span class="o">*</span><span class="n">uy_yp</span><span class="o">*</span><span class="n">duydy_yp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">156</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_adv_y_y.pdf"><img alt="../../_images/update_velocity_adv_y_y.pdf" src="../../_images/update_velocity_adv_y_y.pdf" style="width: 800px;" /></a>
</details></li>
</ol>
</li>
<li><p>Diffusive terms (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">dif1</span><span class="w"></span></code>, <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">dif2</span><span class="w"></span></code>)</p>
<ol class="arabic">
<li><p><code class="code highlight c-lang c docutils literal highlight-c"><span class="n">dif1</span><span class="w"></span></code>: Diffusion of <span class="math notranslate nohighlight">\(\uy\)</span> in <span class="math notranslate nohighlight">\(x\)</span> direction</p>
<div class="math notranslate nohighlight">
\[\vat{
   \frac{\sqrt{Pr}}{\sqrt{Ra}} \dder{}{x} \left( \dder{\uy}{x} \right)
}{\yic, \yjc}\]</div>
<details>
<summary>
Details</summary><p>The implementation leads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">159</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">dif1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">160</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">161</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">prefactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">Pr</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ra</span><span class="p">);</span><span class="w"></span>
<span class="linenos">162</span><span class="w">        </span><span class="n">dif1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefactor</span><span class="o">*</span><span class="p">(</span><span class="n">duydx_xp</span><span class="o">-</span><span class="n">duydx_xm</span><span class="p">)</span><span class="o">/</span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">163</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_dif_y_x.pdf"><img alt="../../_images/update_velocity_dif_y_x.pdf" src="../../_images/update_velocity_dif_y_x.pdf" style="width: 800px;" /></a>
</details></li>
<li><p><code class="code highlight c-lang c docutils literal highlight-c"><span class="n">dif2</span><span class="w"></span></code>: Diffusion of <span class="math notranslate nohighlight">\(\uy\)</span> in <span class="math notranslate nohighlight">\(y\)</span> direction</p>
<div class="math notranslate nohighlight">
\[\vat{
   \frac{\sqrt{Pr}}{\sqrt{Ra}} \dder{}{y} \left( \dder{\uy}{y} \right)
}{\yic, \yjc}\]</div>
<details>
<summary>
Details</summary><p>The implementation leads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">165</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">dif2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">166</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">167</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">prefactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">Pr</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ra</span><span class="p">);</span><span class="w"></span>
<span class="linenos">168</span><span class="w">        </span><span class="n">dif2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefactor</span><span class="o">*</span><span class="p">(</span><span class="n">duydy_yp</span><span class="o">-</span><span class="n">duydy_ym</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="linenos">169</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/update_velocity_dif_y_y.pdf"><img alt="../../_images/update_velocity_dif_y_y.pdf" src="../../_images/update_velocity_dif_y_y.pdf" style="width: 800px;" /></a>
</details></li>
</ol>
</li>
<li><p>Pressure-gradient term (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">pre</span><span class="w"></span></code>)</p>
<div class="math notranslate nohighlight">
\[-
\vat{
   \dder{p}{y}
}{\yic, \yjc}\]</div>
<details>
<summary>
Details</summary><p>The implementation leads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">172</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">pre</span><span class="p">;</span><span class="w"></span>
<span class="linenos">173</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">174</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">p_ym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">P</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">175</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">p_yp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">P</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">176</span><span class="w">        </span><span class="n">pre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">p_yp</span><span class="o">-</span><span class="n">p_ym</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="linenos">177</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</details></li>
</ol>
<p>After all source terms are evaluated, they are assigned to the corresponding variable.</p>
<p>Terms which are treated explicitly are summed up to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuya</span><span class="w"></span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">180</span><span class="w">      </span><span class="n">SRCUYA</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">181</span><span class="w">        </span><span class="o">+</span><span class="p">(</span><span class="n">adv1</span><span class="o">+</span><span class="n">adv2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">182</span><span class="w">        </span><span class="o">+</span><span class="p">(</span><span class="mf">1.-1.</span><span class="o">*</span><span class="n">implicitx</span><span class="p">)</span><span class="o">*</span><span class="n">dif1</span><span class="w"></span>
<span class="linenos">183</span><span class="w">        </span><span class="o">+</span><span class="p">(</span><span class="mf">1.-1.</span><span class="o">*</span><span class="n">implicity</span><span class="p">)</span><span class="o">*</span><span class="n">dif2</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Advective terms (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv1</span><span class="w"></span></code>, <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">adv2</span><span class="w"></span></code>) are involved since they are always treated explicitly.</p>
<p>Diffusive terms are summed up here when treated explicitly (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">implicitx</span><span class="w"></span></code> or <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">implicity</span><span class="w"></span></code> is <span class="math notranslate nohighlight">\(0\)</span>), while are neglected here when treated implicitly (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">implicitx</span><span class="w"></span></code> or <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">implicity</span><span class="w"></span></code> is <span class="math notranslate nohighlight">\(1\)</span>).</p>
<p>Instead, they are summed up to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuyg</span><span class="w"></span></code> when treated implicitly:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">185</span><span class="w">      </span><span class="n">SRCUYG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">186</span><span class="w">        </span><span class="o">+</span><span class="p">(</span><span class="w">  </span><span class="o">+</span><span class="mf">1.</span><span class="o">*</span><span class="n">implicitx</span><span class="p">)</span><span class="o">*</span><span class="n">dif1</span><span class="w"></span>
<span class="linenos">187</span><span class="w">        </span><span class="o">+</span><span class="p">(</span><span class="w">  </span><span class="o">+</span><span class="mf">1.</span><span class="o">*</span><span class="n">implicity</span><span class="p">)</span><span class="o">*</span><span class="n">dif2</span><span class="w"></span>
<span class="linenos">188</span><span class="w">        </span><span class="o">+</span><span class="n">pre</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Pressure gradient term (<code class="code highlight c-lang c docutils literal highlight-c"><span class="n">pre</span><span class="w"></span></code>) is always treated implicitly.</p>
</section>
</section>
<section id="update-ux">
<h2>update_ux<a class="headerlink" href="#update-ux" title="Permalink to this heading">¶</a></h2>
<section id="id7">
<h3>Definition<a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">update_ux</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">param_t</span><span class="w"> </span><span class="o">*</span><span class="n">param</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">parallel_t</span><span class="w"> </span><span class="o">*</span><span class="n">parallel</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fluid_t</span><span class="w"> </span><span class="o">*</span><span class="n">fluid</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>intent</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>param</p></td>
<td><p>in</p></td>
<td><p>general parameters</p></td>
</tr>
<tr class="row-odd"><td><p>parallel</p></td>
<td><p>in</p></td>
<td><p>MPI parameters</p></td>
</tr>
<tr class="row-even"><td><p>fluid</p></td>
<td><p>in/out</p></td>
<td><p>source terms (in), <span class="math notranslate nohighlight">\(x\)</span> velocity (out)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id8">
<h3>Description<a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h3>
<p>New but non-solenoidal velocity in <span class="math notranslate nohighlight">\(x\)</span> direction <span class="math notranslate nohighlight">\(\ux^*\)</span> is obtained by using the source terms computed in <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">compute_src_ux</span><span class="w"></span></code>.</p>
<p>First of all, the velocity increment in <span class="math notranslate nohighlight">\(x\)</span> direction <span class="math notranslate nohighlight">\(\delta \ux \equiv \ux^* - \ux^k\)</span> is computed:</p>
<div class="math notranslate nohighlight">
\[\delta \ux = \left(
     \alpha^k \mathcal{A}_x
   + \beta^k  \mathcal{B}_x
   + \gamma^k \mathcal{G}_x
\right) \Delta t,\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathcal{A}_x\)</span>, <span class="math notranslate nohighlight">\(\mathcal{B}_x\)</span>, and <span class="math notranslate nohighlight">\(\mathcal{G}_x\)</span> are source terms which are already computed in <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">compute_src_ux</span><span class="w"></span></code> and correspond to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuxa</span><span class="w"></span></code>, <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuxb</span><span class="w"></span></code>, and <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuxg</span><span class="w"></span></code>, respectively.</p>
<p>As discussed in <a class="reference internal" href="../../numerical_method/temporal_discretisation/smac_method.html#smac-method"><span class="std std-ref">the temporal discretisation</span></a>, the update process differs for different diffusive treatments.
When all diffusive terms are treated explicitly in time, we simply have</p>
<div class="math notranslate nohighlight">
\[\ux^* = \ux^k + \delta \ux.\]</div>
<p>When the diffusive terms are partially treated implicitly (e.g., only <span class="math notranslate nohighlight">\(x\)</span> direction), we have</p>
<div class="math notranslate nohighlight">
\[\ux^* = \ux^k + \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta x^2} \right)^{-1} \delta \ux,\]</div>
<p>where linear systems in <span class="math notranslate nohighlight">\(x\)</span> direction need to be solved.</p>
<p>When all diffusive terms are treated implicitly, we have</p>
<div class="math notranslate nohighlight">
\[\ux^* = \ux^k + \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta y^2} \right)^{-1} \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta x^2} \right)^{-1} \delta \ux,\]</div>
<p>where linear systems in each direction should be solved.</p>
<p>Based on these relations, the updating procedure is as follows.</p>
<ol class="arabic">
<li><p>Compute <span class="math notranslate nohighlight">\(\delta \ux\)</span></p>
<details>
<summary>
Details</summary><p>The velocity increment in <span class="math notranslate nohighlight">\(x\)</span> direction <span class="math notranslate nohighlight">\(\delta \ux\)</span> is computed and assigned to a variable <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">qx</span><span class="w"></span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">220</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;=</span><span class="n">jsize</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">221</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">222</span><span class="w">      </span><span class="n">QX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">223</span><span class="w">          </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0.</span><span class="w"></span>
<span class="linenos">224</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0.</span><span class="w"></span>
<span class="linenos">225</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="o">+</span><span class="n">alpha</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">SRCUXA</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"></span>
<span class="linenos">226</span><span class="w">          </span><span class="o">+</span><span class="n">beta</span><span class="w"> </span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">SRCUXB</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"></span>
<span class="linenos">227</span><span class="w">          </span><span class="o">+</span><span class="n">gamma</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">SRCUXG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="linenos">228</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">229</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</details></li>
<li><p>Solve linear systems in <span class="math notranslate nohighlight">\(x\)</span> direction (<strong>only when</strong> the diffusive term in <span class="math notranslate nohighlight">\(x\)</span> direction is treated implicitly)</p>
<details>
<summary>
Details</summary><p>We consider</p>
<div class="math notranslate nohighlight">
\[\delta \ux^{\prime} \equiv \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta x^2} \right)^{-1} \delta \ux\]</div>
<p>or in other words</p>
<div class="math notranslate nohighlight">
\[\left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta x^2} \right) \delta \ux^{\prime}
= \delta \ux^{\prime} - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2 \left( \delta \ux^{\prime} \right)}{\delta x^2}
= \delta \ux.\]</div>
<p>Hereafter, for notational simplicity,</p>
<blockquote>
<div><ul class="simple">
<li><p>instead of <span class="math notranslate nohighlight">\(\delta \ux^{\prime}\)</span> and <span class="math notranslate nohighlight">\(\delta \ux\)</span>, <span class="math notranslate nohighlight">\(q^{\prime}\)</span> and <span class="math notranslate nohighlight">\(q\)</span> are used,</p></li>
<li><p><span class="math notranslate nohighlight">\(j\)</span> is dropped since the following discussion holds for each <span class="math notranslate nohighlight">\(\xjc\)</span>.</p></li>
</ul>
</div></blockquote>
<p>The second-order derivative of <span class="math notranslate nohighlight">\(q^{\prime}\)</span> in <span class="math notranslate nohighlight">\(x\)</span> direction should be discretised with the same discrete operator used to compute the diffusive term, i.e.,</p>
<div class="math notranslate nohighlight">
\[\vat{\frac{\delta^2 q^{\prime}}{\delta x^2}}{\xic}
= c_{\ximm} \vat{q^{\prime}}{\ximm}
+ c_{\xic } \vat{q^{\prime}}{\xic }
+ c_{\xipp} \vat{q^{\prime}}{\xipp},\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
   c_{\ximm} &amp; = \frac{1}{\Delta x_{\xic} \Delta x_{\xim}}, \\
   c_{\xipp} &amp; = \frac{1}{\Delta x_{\xic} \Delta x_{\xip}}, \\
   c_{\xic } &amp; = -c_{\ximm}-c_{\xipp}.
\end{aligned}\end{split}\]</div>
<p>Thus, the equation of <span class="math notranslate nohighlight">\(q^{\prime}\)</span> can be discretised as</p>
<div class="math notranslate nohighlight">
\[\begin{split}-            \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\ximm}         \vat{q^{\prime}}{\ximm}
+ \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\xic } \right) \vat{q^{\prime}}{\xic }
-            \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\xipp}         \vat{q^{\prime}}{\xipp} \\
= \vat{q}{\xic}.\end{split}\]</div>
<p>For simplicity, we write this as</p>
<div class="math notranslate nohighlight">
\[l_{\ximm} \vat{q^{\prime}}{\ximm}
+ c_{\xic } \vat{q^{\prime}}{\xic }
+ u_{\xipp} \vat{q^{\prime}}{\xipp}
= \vat{q}{\xic},\]</div>
<p>which is implemented as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">248</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">249</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="p">){</span><span class="w"></span>
<span class="linenos">250</span><span class="w">          </span><span class="n">TDM_L</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span><span class="w"></span>
<span class="linenos">251</span><span class="w">          </span><span class="n">TDM_U</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span><span class="w"></span>
<span class="linenos">252</span><span class="w">          </span><span class="n">TDM_C</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="p">;</span><span class="w"></span>
<span class="linenos">253</span><span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos">254</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">prefactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gamma</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Pr</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ra</span><span class="p">));</span><span class="w"></span>
<span class="linenos">255</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_xm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">/</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">)</span><span class="o">/</span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">256</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">/</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">)</span><span class="o">/</span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">257</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">coef_xm</span><span class="o">-</span><span class="n">coef_xp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">258</span><span class="w">          </span><span class="n">TDM_L</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_xm</span><span class="p">;</span><span class="w"></span>
<span class="linenos">259</span><span class="w">          </span><span class="n">TDM_U</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_xp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">260</span><span class="w">          </span><span class="n">TDM_C</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_x0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">261</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">262</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Recall the difference of the notations; <span class="math notranslate nohighlight">\(\xic\)</span> corresponds to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">i</span><span class="w"></span></code>, i.e., the left bound is <span class="math notranslate nohighlight">\(i = \frac{1}{2}\)</span> and <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span></code>, whereas the right bound is <span class="math notranslate nohighlight">\(i = \text{itot}+\frac{1}{2}\)</span> and <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="w"></span></code>.</p>
<p>This can be written as a linear system (whose size is <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="w"></span></code>):</p>
<div class="math notranslate nohighlight">
\[\begin{split}\newcommand\ia{\frac{1}{2}}
\newcommand\ib{\frac{3}{2}}
\newcommand\ic{\frac{5}{2}}
\newcommand\id{i-\frac{1}{2}}
\newcommand\ie{i+\frac{1}{2}}
\newcommand\if{i+\frac{3}{2}}
\newcommand\ig{\text{itot}-\frac{3}{2}}
\newcommand\ih{\text{itot}-\frac{1}{2}}
\newcommand\ii{\text{itot}+\frac{1}{2}}
\begin{bmatrix}
   1       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   l_{\ib} &amp; c_{\ib} &amp; u_{\ib} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; l_{\ic} &amp; c_{\ic} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   \vdots  &amp; \vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  &amp; \vdots  &amp; \vdots  &amp;        &amp; \vdots  &amp; \vdots  &amp; \vdots  \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; c_{\id} &amp; u_{\id} &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; l_{\ie} &amp; c_{\ie} &amp; u_{\ie} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; l_{\if} &amp; c_{\if} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   \vdots  &amp; \vdots  &amp; \vdots  &amp;        &amp; \vdots  &amp; \vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  &amp; \vdots  &amp; \vdots  \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; c_{\ig} &amp; u_{\ig} &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; l_{\ih} &amp; c_{\ih} &amp; u_{\ih} \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 1
\end{bmatrix}
\begin{bmatrix}
   \vat{q^{\prime}}{\ia} \\
   \vat{q^{\prime}}{\ib} \\
   \vat{q^{\prime}}{\ic} \\
   \vdots                                   \\
   \vat{q^{\prime}}{\id} \\
   \vat{q^{\prime}}{\ie} \\
   \vat{q^{\prime}}{\if} \\
   \vdots                                   \\
   \vat{q^{\prime}}{\ig} \\
   \vat{q^{\prime}}{\ih} \\
   \vat{q^{\prime}}{\ii}
\end{bmatrix}
=
\begin{bmatrix}
   \vat{q}{\ia} \\
   \vat{q}{\ib} \\
   \vat{q}{\ic} \\
   \vdots                          \\
   \vat{q}{\id} \\
   \vat{q}{\ie} \\
   \vat{q}{\if} \\
   \vdots                          \\
   \vat{q}{\ig} \\
   \vat{q}{\ih} \\
   \vat{q}{\ii}
\end{bmatrix},\end{split}\]</div>
<p>where the first matrix in the left-hand-side is the tri-diagonal matrix, which can be solved by the <a class="reference external" href="https://en.wikipedia.org/wiki/Tridiagonal_matrix_algorithm">tri-diagonal matrix algorithm</a>.
See <a class="reference internal" href="../linalg.html#linalg"><span class="std std-ref">src/linalg.c</span></a> for details.</p>
<p>Note that the matrix is already diagonalised at the edges, i.e., we already have solutions</p>
<div class="math notranslate nohighlight">
\[\begin{split}\newcommand\ia{\frac{1}{2}}
\newcommand\ii{\text{itot}+\frac{1}{2}}
\vat{\delta \ux^{\prime}}{\ia} &amp;= \vat{\delta \ux}{\ia} = 0, \\
\vat{\delta \ux^{\prime}}{\ii} &amp;= \vat{\delta \ux}{\ii} = 0,\end{split}\]</div>
<p>since the walls are assumed to be impermeable and thus the boundary condition does not change in time.
Although these two rows can be removed to obtain an equivalent linear system (whose size is <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">itot</span><span class="mi">-1</span><span class="w"></span></code>), here we include them for simplicity.</p>
<p>Finally the linear system is solved</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">264</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">265</span><span class="w">        </span><span class="n">TDM_Q</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="linenos">266</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos">267</span><span class="w">      </span><span class="n">my_dgtsv_b</span><span class="p">(</span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_l</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_c</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_u</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_q</span><span class="p">);</span><span class="w"></span>
<span class="linenos">268</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">269</span><span class="w">        </span><span class="n">QX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TDM_Q</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">270</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</details></li>
<li><p>Solve linear systems in <span class="math notranslate nohighlight">\(y\)</span> direction (<strong>only when</strong> the diffusive term in <span class="math notranslate nohighlight">\(y\)</span> direction is treated implicitly)</p>
<details>
<summary>
Details</summary><p>We consider</p>
<div class="math notranslate nohighlight">
\[\delta \ux^{\prime\prime} \equiv \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta y^2} \right)^{-1} \delta \ux^{\prime}.\]</div>
<p>To do so, all <span class="math notranslate nohighlight">\(y\)</span> values at each <span class="math notranslate nohighlight">\(x\)</span> location should be contained by one processor.
By default, this is not the case since the domain is split in <span class="math notranslate nohighlight">\(y\)</span> direction.
Thus the matrix must be transposed beforehand, which is achieved by</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">284</span><span class="w">    </span><span class="n">parallel_transpose</span><span class="p">(</span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jtot</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">qx</span><span class="p">,</span><span class="w"> </span><span class="n">qy</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Also see the schematic below for an intuitive understanding, where a domain whose sizes are <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">itot</span><span class="o">=</span><span class="mi">7</span><span class="w"></span></code> (thus size of <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">qx</span><span class="w"></span></code> in <span class="math notranslate nohighlight">\(x\)</span> direction is <code class="code highlight c-lang c docutils literal highlight-c"><span class="mi">8</span><span class="w"></span></code>) and <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">jtot</span><span class="o">=</span><span class="mi">11</span><span class="w"></span></code> is drawn:</p>
<a class="reference internal image-reference" href="../../_images/update_velocity_domain_decomp_x.pdf"><img alt="../../_images/update_velocity_domain_decomp_x.pdf" src="../../_images/update_velocity_domain_decomp_x.pdf" style="width: 800px;" /></a>
<p>Here <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">qx</span><span class="w"></span></code> (left figure) is transposed to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">qy</span><span class="w"></span></code> (right figure) and the alignment is modified to <span class="math notranslate nohighlight">\(y\)</span> direction (note that memory is contiguous in <span class="math notranslate nohighlight">\(y\)</span> direction after being transposed, which was contiguous in <span class="math notranslate nohighlight">\(x\)</span> direction before).</p>
<p>We consider</p>
<div class="math notranslate nohighlight">
\[\delta \ux^{\prime\prime} \equiv \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta y^2} \right)^{-1} \delta \ux^{\prime}\]</div>
<p>or in other words</p>
<div class="math notranslate nohighlight">
\[\left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta y^2} \right) \delta \ux^{\prime\prime}
= \delta \ux^{\prime\prime} - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2 \left( \delta \ux^{\prime\prime} \right)}{\delta y^2}
= \delta \ux^{\prime}.\]</div>
<p>Hereafter, for notational simplicity,</p>
<blockquote>
<div><ul class="simple">
<li><p>instead of <span class="math notranslate nohighlight">\(\delta \ux^{\prime\prime}\)</span> and <span class="math notranslate nohighlight">\(\delta \ux^{\prime}\)</span>, <span class="math notranslate nohighlight">\(q^{\prime\prime}\)</span> and <span class="math notranslate nohighlight">\(q^{\prime}\)</span> are used,</p></li>
<li><p><span class="math notranslate nohighlight">\(i\)</span> is dropped since the following discussion holds for each <span class="math notranslate nohighlight">\(\xic\)</span>.</p></li>
</ul>
</div></blockquote>
<p>The second-order derivative of <span class="math notranslate nohighlight">\(q^{\prime\prime}\)</span> in <span class="math notranslate nohighlight">\(y\)</span> direction should be discretised with the same discrete operator used to compute the diffusive term, i.e.,</p>
<div class="math notranslate nohighlight">
\[\vat{\frac{\delta^2 q^{\prime\prime}}{\delta y^2}}{\xjc}
= c_{\xjmm} \vat{q^{\prime\prime}}{\xjmm}
+ c_{\xjc } \vat{q^{\prime\prime}}{\xjc }
+ c_{\xjpp} \vat{q^{\prime\prime}}{\xjpp},\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
   c_{\xjmm} &amp; = \frac{1}{\Delta y^2}, \\
   c_{\xjpp} &amp; = \frac{1}{\Delta y^2}, \\
   c_{\xjc } &amp; = -c_{\xjmm}-c_{\xjpp}.
\end{aligned}\end{split}\]</div>
<p>Thus, the equation of <span class="math notranslate nohighlight">\(q^{\prime\prime}\)</span> can be discretised as</p>
<div class="math notranslate nohighlight">
\[-            \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\xjmm}         \vat{q^{\prime\prime}}{\xjmm}
+ \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\xjc } \right) \vat{q^{\prime\prime}}{\xjc }
-            \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\xjpp}         \vat{q^{\prime\prime}}{\xjpp}
= \vat{q^{\prime}}{\xjc}.\]</div>
<p>For simplicity, we write this as</p>
<div class="math notranslate nohighlight">
\[l_{\xjmm} \vat{q^{\prime\prime}}{\xjmm}
+ c_{\xjc } \vat{q^{\prime\prime}}{\xjc }
+ u_{\xjpp} \vat{q^{\prime\prime}}{\xjpp}
= \vat{q^{\prime}}{\xjc},\]</div>
<p>which is implemented as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">302</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;=</span><span class="n">jtot</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">303</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">prefactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gamma</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Pr</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ra</span><span class="p">));</span><span class="w"></span>
<span class="linenos">304</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_ym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">/</span><span class="n">dy</span><span class="o">/</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="linenos">305</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_yp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">/</span><span class="n">dy</span><span class="o">/</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="linenos">306</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">coef_ym</span><span class="o">-</span><span class="n">coef_yp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">307</span><span class="w">        </span><span class="n">TDM_L</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_ym</span><span class="p">;</span><span class="w"></span>
<span class="linenos">308</span><span class="w">        </span><span class="n">TDM_U</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_yp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">309</span><span class="w">        </span><span class="n">TDM_C</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_y0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">310</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This can be written as a linear system (whose size is <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">jtot</span><span class="w"></span></code>)</p>
<div class="math notranslate nohighlight">
\[\begin{split}\newcommand\ia{1}
\newcommand\ib{2}
\newcommand\ic{3}
\newcommand\id{j-1}
\newcommand\ie{j  }
\newcommand\if{j+1}
\newcommand\ig{\text{jtot}-2}
\newcommand\ih{\text{jtot}-1}
\newcommand\ii{\text{jtot}  }
\begin{bmatrix}
   c_{\ia} &amp; u_{\ia} &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; l_{ia}  \\
   l_{\ib} &amp; c_{\ib} &amp; u_{\ib} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; l_{\ic} &amp; c_{\ic} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   \vdots  &amp; \vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  &amp; \vdots  &amp; \vdots  &amp;        &amp; \vdots  &amp; \vdots  &amp; \vdots  \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; c_{\id} &amp; u_{\id} &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; l_{\ie} &amp; c_{\ie} &amp; u_{\ie} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; l_{\if} &amp; c_{\if} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   \vdots  &amp; \vdots  &amp; \vdots  &amp;        &amp; \vdots  &amp; \vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  &amp; \vdots  &amp; \vdots  \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; c_{\ig} &amp; u_{\ig} &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; l_{\ih} &amp; c_{\ih} &amp; u_{\ih} \\
   u_{\ii} &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; l_{\ii} &amp; c_{\ii}
\end{bmatrix}
\begin{bmatrix}
   \vat{q^{\prime\prime}}{\ia} \\
   \vat{q^{\prime\prime}}{\ib} \\
   \vat{q^{\prime\prime}}{\ic} \\
   \vdots                      \\
   \vat{q^{\prime\prime}}{\id} \\
   \vat{q^{\prime\prime}}{\ie} \\
   \vat{q^{\prime\prime}}{\if} \\
   \vdots                      \\
   \vat{q^{\prime\prime}}{\ig} \\
   \vat{q^{\prime\prime}}{\ih} \\
   \vat{q^{\prime\prime}}{\ii}
\end{bmatrix}
=
\begin{bmatrix}
  \vat{q^{\prime}}{\ia} \\
  \vat{q^{\prime}}{\ib} \\
  \vat{q^{\prime}}{\ic} \\
  \vdots                \\
  \vat{q^{\prime}}{\id} \\
  \vat{q^{\prime}}{\ie} \\
  \vat{q^{\prime}}{\if} \\
  \vdots                \\
  \vat{q^{\prime}}{\ig} \\
  \vat{q^{\prime}}{\ih} \\
  \vat{q^{\prime}}{\ii}
\end{bmatrix},\end{split}\]</div>
<p>where the first matrix in the left-hand-side is the modified (i.e., periodic boundary) tri-diagonal matrix, which can be solved by the <a class="reference external" href="https://en.wikipedia.org/wiki/Tridiagonal_matrix_algorithm">tri-diagonal matrix algorithm</a> with <a class="reference external" href="https://en.wikipedia.org/wiki/Sherman–Morrison_formula">Sherman–Morrison formula</a>.
See <a class="reference internal" href="../linalg.html#linalg"><span class="std std-ref">src/linalg.c</span></a> for details.</p>
<p>Finally, the linear system is solved</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">313</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;=</span><span class="n">jtot</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">314</span><span class="w">        </span><span class="n">TDM_Q</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="linenos">315</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos">316</span><span class="w">      </span><span class="n">my_dgtsv_p</span><span class="p">(</span><span class="n">jtot</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_l</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_c</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_u</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_q</span><span class="p">);</span><span class="w"></span>
<span class="linenos">317</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;=</span><span class="n">jtot</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">318</span><span class="w">        </span><span class="n">QY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TDM_Q</span><span class="p">(</span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="linenos">319</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>After all linear systems are solved, the <span class="math notranslate nohighlight">\(y\)</span>-aligned memory alignment is modified to the original <span class="math notranslate nohighlight">\(x\)</span>-aligned one by transposing the matrix again:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">331</span><span class="w">    </span><span class="n">parallel_transpose</span><span class="p">(</span><span class="n">jtot</span><span class="p">,</span><span class="w"> </span><span class="n">itot</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">qy</span><span class="p">,</span><span class="w"> </span><span class="n">qx</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</details></li>
<li><p>Update <span class="math notranslate nohighlight">\(\ux^k\)</span> to <span class="math notranslate nohighlight">\(\ux^*\)</span></p>
<details>
<summary>
Details</summary><p>Now the increment is ready, which is added to the velocity in <span class="math notranslate nohighlight">\(x\)</span> direction <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">ux</span><span class="w"></span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">335</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;=</span><span class="n">jsize</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">336</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">itot</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">337</span><span class="w">      </span><span class="n">UX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">QX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="linenos">338</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">339</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</details></li>
</ol>
</section>
</section>
<section id="update-uy">
<h2>update_uy<a class="headerlink" href="#update-uy" title="Permalink to this heading">¶</a></h2>
<section id="id10">
<h3>Definition<a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">update_uy</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">param_t</span><span class="w"> </span><span class="o">*</span><span class="n">param</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">parallel_t</span><span class="w"> </span><span class="o">*</span><span class="n">parallel</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fluid_t</span><span class="w"> </span><span class="o">*</span><span class="n">fluid</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>intent</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>param</p></td>
<td><p>in</p></td>
<td><p>general parameters</p></td>
</tr>
<tr class="row-odd"><td><p>parallel</p></td>
<td><p>in</p></td>
<td><p>MPI parameters</p></td>
</tr>
<tr class="row-even"><td><p>fluid</p></td>
<td><p>in/out</p></td>
<td><p>source terms (in), <span class="math notranslate nohighlight">\(y\)</span> velocity (out)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id11">
<h3>Description<a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h3>
<p>New but non-solenoidal velocity in <span class="math notranslate nohighlight">\(y\)</span> direction <span class="math notranslate nohighlight">\(\uy^*\)</span> is obtained by using the source terms computed in <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">compute_src_uy</span><span class="w"></span></code>.</p>
<p>First of all, the velocity increment in <span class="math notranslate nohighlight">\(y\)</span> direction <span class="math notranslate nohighlight">\(\delta \uy \equiv \uy^* - \uy^k\)</span> is computed:</p>
<div class="math notranslate nohighlight">
\[\delta \uy = \left(
     \alpha^k \mathcal{A}_y
   + \beta^k  \mathcal{B}_y
   + \gamma^k \mathcal{G}_y
\right) \Delta t,\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathcal{A}_y\)</span>, <span class="math notranslate nohighlight">\(\mathcal{B}_y\)</span>, and <span class="math notranslate nohighlight">\(\mathcal{G}_y\)</span> are source terms which are already computed in <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">compute_src_uy</span><span class="w"></span></code> and correspond to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuya</span><span class="w"></span></code>, <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuyb</span><span class="w"></span></code>, and <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">srcuyg</span><span class="w"></span></code>, respectively.</p>
<p>As discussed in <a class="reference internal" href="../../numerical_method/temporal_discretisation/smac_method.html#smac-method"><span class="std std-ref">the temporal discretisation</span></a>, the update process differs for different diffusive treatments.
When all diffusive terms are treated explicitly in time, we simply have</p>
<div class="math notranslate nohighlight">
\[\uy^* = \uy^k + \delta \uy.\]</div>
<p>When the diffusive terms are partially treated implicitly (e.g., only <span class="math notranslate nohighlight">\(x\)</span> direction), we have</p>
<div class="math notranslate nohighlight">
\[\uy^* = \uy^k + \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta x^2} \right)^{-1} \delta \uy,\]</div>
<p>where linear systems in <span class="math notranslate nohighlight">\(x\)</span> direction needs to be solved.</p>
<p>When all diffusive terms are treated implicitly, we have</p>
<div class="math notranslate nohighlight">
\[\uy^* = \uy^k + \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta y^2} \right)^{-1} \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta x^2} \right)^{-1} \delta \uy,\]</div>
<p>where linear systems in each direction should be solved.</p>
<p>Based on these relations, the updating procedure is as follows.</p>
<ol class="arabic">
<li><p>Compute <span class="math notranslate nohighlight">\(\delta \uy\)</span></p>
<details>
<summary>
Details</summary><p>The velocity increment in <span class="math notranslate nohighlight">\(y\)</span> direction <span class="math notranslate nohighlight">\(\delta \uy\)</span> is computed and assigned to a variable <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">qx</span><span class="w"></span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">372</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;=</span><span class="n">jsize</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">373</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">itot</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">374</span><span class="w">      </span><span class="n">QX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">375</span><span class="w">        </span><span class="o">+</span><span class="n">alpha</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">SRCUYA</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"></span>
<span class="linenos">376</span><span class="w">        </span><span class="o">+</span><span class="n">beta</span><span class="w"> </span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">SRCUYB</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"></span>
<span class="linenos">377</span><span class="w">        </span><span class="o">+</span><span class="n">gamma</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">SRCUYG</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="linenos">378</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">379</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</details></li>
<li><p>Solve linear systems in <span class="math notranslate nohighlight">\(x\)</span> direction (<strong>only when</strong> the diffusive term in <span class="math notranslate nohighlight">\(x\)</span> direction is treated implicitly)</p>
<details>
<summary>
Details</summary><p>We consider</p>
<div class="math notranslate nohighlight">
\[\delta \uy^{\prime} \equiv \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta x^2} \right)^{-1} \delta \uy\]</div>
<p>or in other words</p>
<div class="math notranslate nohighlight">
\[\left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta x^2} \right) \delta \uy^{\prime}
 = \delta \uy^{\prime} - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2 \left( \delta \uy^{\prime} \right)}{\delta x^2}
 = \delta \uy.\]</div>
<p>Hereafter, for notational simplicity,</p>
<blockquote>
<div><ul class="simple">
<li><p>instead of <span class="math notranslate nohighlight">\(\delta \uy^{\prime}\)</span> and <span class="math notranslate nohighlight">\(\delta \uy\)</span>, <span class="math notranslate nohighlight">\(q^{\prime}\)</span> and <span class="math notranslate nohighlight">\(q\)</span> are used,</p></li>
<li><p><span class="math notranslate nohighlight">\(j\)</span> is dropped since the following discussion holds for each <span class="math notranslate nohighlight">\(\yjc\)</span>.</p></li>
</ul>
</div></blockquote>
<p>The second-order derivative of <span class="math notranslate nohighlight">\(q^{\prime}\)</span> in <span class="math notranslate nohighlight">\(x\)</span> direction should be discretised with the same discrete operator used to compute the diffusive term, i.e.,</p>
<div class="math notranslate nohighlight">
\[\vat{\frac{\delta^2 q}{\delta x^2}}{\yic}
= c_{\yimm} \vat{q}{\yimm}
+ c_{\yic } \vat{q}{\yic }
+ c_{\yipp} \vat{q}{\yipp},\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}c_{\yimm} &amp; = \frac{1}{\Delta x_{\yic} \Delta x_{\yim}}, \\
c_{\yipp} &amp; = \frac{1}{\Delta x_{\yic} \Delta x_{\yip}}, \\
c_{\yic } &amp; = -c_{\yimm}-c_{\yipp},\end{split}\]</div>
<p>Based on this, the equation of <span class="math notranslate nohighlight">\(\uy^{\prime}\)</span> can be discretised as</p>
<div class="math notranslate nohighlight">
\[-            \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\yimm}         \vat{q^{\prime}}{\yimm}
+ \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\yic } \right) \vat{q^{\prime}}{\yic }
-            \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\yipp}         \vat{q^{\prime}}{\yipp}
= \vat{q}{\yic},\]</div>
<p>For simplicity, we write this as</p>
<div class="math notranslate nohighlight">
\[l_{\yimm} \vat{q^{\prime}}{\yimm}
+ c_{\yic } \vat{q^{\prime}}{\yic }
+ u_{\yipp} \vat{q^{\prime}}{\yipp}
= \vat{q}{\yic},\]</div>
<p>which is implemented as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">398</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">itot</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">399</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">prefactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gamma</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Pr</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ra</span><span class="p">));</span><span class="w"></span>
<span class="linenos">400</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_xm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">/</span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="linenos">401</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">/</span><span class="n">DXF</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">DXC</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">402</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">coef_xm</span><span class="o">-</span><span class="n">coef_xp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">403</span><span class="w">        </span><span class="n">TDM_L</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_xm</span><span class="p">;</span><span class="w"></span>
<span class="linenos">404</span><span class="w">        </span><span class="n">TDM_U</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_xp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">405</span><span class="w">        </span><span class="n">TDM_C</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_x0</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>This can be written as a linear system (whose size is <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">itot</span><span class="w"></span></code>)</p>
<div class="math notranslate nohighlight">
\[\begin{split}\newcommand\ia{1}
\newcommand\ib{2}
\newcommand\ic{3}
\newcommand\id{i-1}
\newcommand\ie{i  }
\newcommand\if{i+1}
\newcommand\ig{\text{itot}-2}
\newcommand\ih{\text{itot}-1}
\newcommand\ii{\text{itot}  }
\begin{bmatrix}
   c_{\ia} &amp; u_{\ia} &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   l_{\ib} &amp; c_{\ib} &amp; u_{\ib} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; l_{\ic} &amp; c_{\ic} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   \vdots  &amp; \vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  &amp; \vdots  &amp; \vdots  &amp;        &amp; \vdots  &amp; \vdots  &amp; \vdots  \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; c_{\id} &amp; u_{\id} &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; l_{\ie} &amp; c_{\ie} &amp; u_{\ie} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; l_{\if} &amp; c_{\if} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   \vdots  &amp; \vdots  &amp; \vdots  &amp;        &amp; \vdots  &amp; \vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  &amp; \vdots  &amp; \vdots  \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; c_{\ig} &amp; u_{\ig} &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; l_{\ih} &amp; c_{\ih} &amp; u_{\ih} \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; l_{\ii} &amp; c_{\ii}
\end{bmatrix}
\begin{bmatrix}
   \vat{q^{\prime}}{\ia} \\
   \vat{q^{\prime}}{\ib} \\
   \vat{q^{\prime}}{\ic} \\
   \vdots                \\
   \vat{q^{\prime}}{\id} \\
   \vat{q^{\prime}}{\ie} \\
   \vat{q^{\prime}}{\if} \\
   \vdots                \\
   \vat{q^{\prime}}{\ig} \\
   \vat{q^{\prime}}{\ih} \\
   \vat{q^{\prime}}{\ii}
\end{bmatrix}
=
\begin{bmatrix}
   \vat{q}{\ia} \\
   \vat{q}{\ib} \\
   \vat{q}{\ic} \\
   \vdots       \\
   \vat{q}{\id} \\
   \vat{q}{\ie} \\
   \vat{q}{\if} \\
   \vdots       \\
   \vat{q}{\ig} \\
   \vat{q}{\ih} \\
   \vat{q}{\ii}
\end{bmatrix},\end{split}\]</div>
<p>where the first matrix in the left-hand-side is the tri-diagonal matrix, which can be solved by the <a class="reference external" href="https://en.wikipedia.org/wiki/Tridiagonal_matrix_algorithm">tri-diagonal matrix algorithm</a>.
See <a class="reference internal" href="../linalg.html#linalg"><span class="std std-ref">src/linalg.c</span></a> for details.</p>
<p>Finally the linear system is solved</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">408</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">itot</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">409</span><span class="w">        </span><span class="n">TDM_Q</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="linenos">410</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos">411</span><span class="w">      </span><span class="n">my_dgtsv_b</span><span class="p">(</span><span class="n">itot</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_l</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_c</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_u</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_q</span><span class="p">);</span><span class="w"></span>
<span class="linenos">412</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">itot</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">413</span><span class="w">        </span><span class="n">QX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TDM_Q</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">414</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</details></li>
<li><p>Solve linear systems in <span class="math notranslate nohighlight">\(y\)</span> direction (<strong>only when</strong> the diffusive term in <span class="math notranslate nohighlight">\(y\)</span> direction is treated implicitly)</p>
<details>
<summary>
Details</summary><p>We consider</p>
<div class="math notranslate nohighlight">
\[\delta \uy^{\prime\prime} \equiv \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta y^2} \right)^{-1} \delta \uy^{\prime}.\]</div>
<p>To do so, all <span class="math notranslate nohighlight">\(y\)</span> values at each <span class="math notranslate nohighlight">\(x\)</span> location should be contained by one processor.
This is not the case since the domain is split in <span class="math notranslate nohighlight">\(y\)</span> direction by default.
Thus the matrix must be transposed beforehand, which is achieved by</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">428</span><span class="w">    </span><span class="n">parallel_transpose</span><span class="p">(</span><span class="n">itot</span><span class="p">,</span><span class="w"> </span><span class="n">jtot</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">qx</span><span class="p">,</span><span class="w"> </span><span class="n">qy</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Also see the schematic below for an intuitive understanding, where a domain whose sizes are <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">itot</span><span class="o">=</span><span class="mi">7</span><span class="w"></span></code> (thus size of <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">qx</span><span class="w"></span></code> in <span class="math notranslate nohighlight">\(x\)</span> direction is <code class="code highlight c-lang c docutils literal highlight-c"><span class="mi">8</span><span class="w"></span></code>) and <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">jtot</span><span class="o">=</span><span class="mi">11</span><span class="w"></span></code> is drawn:</p>
<a class="reference internal image-reference" href="../../_images/update_velocity_domain_decomp_y.pdf"><img alt="../../_images/update_velocity_domain_decomp_y.pdf" src="../../_images/update_velocity_domain_decomp_y.pdf" style="width: 800px;" /></a>
<p>Here <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">qx</span><span class="w"></span></code> (left figure) is transposed to <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">qy</span><span class="w"></span></code> (right figure) and the alignment is modified to <span class="math notranslate nohighlight">\(y\)</span> direction (note that memory is contiguous in <span class="math notranslate nohighlight">\(y\)</span> direction after being transposed, which was contiguous in <span class="math notranslate nohighlight">\(x\)</span> direction before).</p>
<p>We consider</p>
<div class="math notranslate nohighlight">
\[\delta \uy^{\prime\prime} \equiv \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta y^2} \right)^{-1} \delta \uy^{\prime}\]</div>
<p>or in other words</p>
<div class="math notranslate nohighlight">
\[\left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2}{\delta y^2} \right) \delta \uy^{\prime\prime}
= \delta \uy^{\prime\prime} - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} \frac{\delta^2 \left( \delta \uy^{\prime\prime} \right)}{\delta y^2}
= \delta \uy^{\prime}.\]</div>
<p>Hereafter, for notational simplicity,</p>
<blockquote>
<div><ul class="simple">
<li><p>instead of <span class="math notranslate nohighlight">\(\delta \uy^{\prime\prime}\)</span> and <span class="math notranslate nohighlight">\(\delta \uy^{\prime}\)</span>, <span class="math notranslate nohighlight">\(q^{\prime\prime}\)</span> and <span class="math notranslate nohighlight">\(q^{\prime}\)</span> are used,</p></li>
<li><p><span class="math notranslate nohighlight">\(i\)</span> is dropped since the following discussion holds for each <span class="math notranslate nohighlight">\(\yic\)</span>.</p></li>
</ul>
</div></blockquote>
<p>The second-order derivative of <span class="math notranslate nohighlight">\(q^{\prime\prime}\)</span> in <span class="math notranslate nohighlight">\(y\)</span> direction should be discretised with the same discrete operator used to compute the diffusive term, i.e.,</p>
<div class="math notranslate nohighlight">
\[\vat{\frac{\delta^2 q}{\delta y^2}}{\yjc}
= c_{\yjmm} \vat{q}{\yjmm}
+ c_{\yjc } \vat{q}{\yjc }
+ c_{\yjpp} \vat{q}{\yjpp},\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
   c_{\yjmm} &amp; = \frac{1}{\Delta y^2}, \\
   c_{\yjpp} &amp; = \frac{1}{\Delta y^2}, \\
   c_{\yjc } &amp; = -c_{\yjmm}-c_{\yjpp},
\end{aligned}\end{split}\]</div>
<p>Thus, the equation of <span class="math notranslate nohighlight">\(q^{\prime\prime}\)</span> can be discretised as</p>
<div class="math notranslate nohighlight">
\[-            \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\yjmm}         \vat{q^{\prime\prime}}{\yjmm}
+ \left( 1 - \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\yjc } \right) \vat{q^{\prime\prime}}{\yjc }
-            \frac{\gamma^k \Delta t \sqrt{Pr}}{2 \sqrt{Ra}} c_{\yjpp}         \vat{q^{\prime\prime}}{\yjpp}
= \vat{q^{\prime}}{\yjc}.\]</div>
<p>For simplicity, we write this as</p>
<div class="math notranslate nohighlight">
\[l_{\yjmm} \vat{q^{\prime\prime}}{\yjmm}
+ c_{\yjc } \vat{q^{\prime\prime}}{\yjc }
+ u_{\yjpp} \vat{q^{\prime\prime}}{\yjpp}
= \vat{q^{\prime}}{\yjc},\]</div>
<p>which is implemented as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">446</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;=</span><span class="n">jtot</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">447</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">prefactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gamma</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Pr</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ra</span><span class="p">));</span><span class="w"></span>
<span class="linenos">448</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_ym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">/</span><span class="n">dy</span><span class="o">/</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="linenos">449</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_yp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">/</span><span class="n">dy</span><span class="o">/</span><span class="n">dy</span><span class="p">;</span><span class="w"></span>
<span class="linenos">450</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">coef_y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">coef_ym</span><span class="o">-</span><span class="n">coef_yp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">451</span><span class="w">        </span><span class="n">TDM_L</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_ym</span><span class="p">;</span><span class="w"></span>
<span class="linenos">452</span><span class="w">        </span><span class="n">TDM_U</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_yp</span><span class="p">;</span><span class="w"></span>
<span class="linenos">453</span><span class="w">        </span><span class="n">TDM_C</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="o">-</span><span class="n">prefactor</span><span class="o">*</span><span class="n">coef_y0</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>This can be written as a linear system (whose size is <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">jtot</span><span class="w"></span></code>)</p>
<div class="math notranslate nohighlight">
\[\begin{split}\newcommand\ia{\frac{1}{2}}
\newcommand\ib{\frac{3}{2}}
\newcommand\ic{\frac{5}{2}}
\newcommand\id{j-\frac{1}{2}}
\newcommand\ie{j+\frac{1}{2}}
\newcommand\if{j+\frac{3}{2}}
\newcommand\ig{\text{jtot}-\frac{3}{2}}
\newcommand\ih{\text{jtot}-\frac{1}{2}}
\newcommand\ii{\text{jtot}+\frac{1}{2}}
\begin{bmatrix}
   c_{\ia} &amp; u_{\ia} &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; l_{ia}  \\
   l_{\ib} &amp; c_{\ib} &amp; u_{\ib} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; l_{\ic} &amp; c_{\ic} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   \vdots  &amp; \vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  &amp; \vdots  &amp; \vdots  &amp;        &amp; \vdots  &amp; \vdots  &amp; \vdots  \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; c_{\id} &amp; u_{\id} &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; l_{\ie} &amp; c_{\ie} &amp; u_{\ie} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; l_{\if} &amp; c_{\if} &amp; \cdots &amp; 0       &amp; 0       &amp; 0       \\
   \vdots  &amp; \vdots  &amp; \vdots  &amp;        &amp; \vdots  &amp; \vdots  &amp; \vdots  &amp; \ddots &amp; \vdots  &amp; \vdots  &amp; \vdots  \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; c_{\ig} &amp; u_{\ig} &amp; 0       \\
   0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; l_{\ih} &amp; c_{\ih} &amp; u_{\ih} \\
   u_{\ii} &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; 0       &amp; 0       &amp; \cdots &amp; 0       &amp; l_{\ii} &amp; c_{\ii}
\end{bmatrix}
\begin{bmatrix}
   \vat{q^{\prime\prime}}{\ia} \\
   \vat{q^{\prime\prime}}{\ib} \\
   \vat{q^{\prime\prime}}{\ic} \\
   \vdots                      \\
   \vat{q^{\prime\prime}}{\id} \\
   \vat{q^{\prime\prime}}{\ie} \\
   \vat{q^{\prime\prime}}{\if} \\
   \vdots                      \\
   \vat{q^{\prime\prime}}{\ig} \\
   \vat{q^{\prime\prime}}{\ih} \\
   \vat{q^{\prime\prime}}{\ii}
\end{bmatrix}
=
\begin{bmatrix}
   \vat{q^{\prime}}{\ia} \\
   \vat{q^{\prime}}{\ib} \\
   \vat{q^{\prime}}{\ic} \\
   \vdots                \\
   \vat{q^{\prime}}{\id} \\
   \vat{q^{\prime}}{\ie} \\
   \vat{q^{\prime}}{\if} \\
   \vdots                \\
   \vat{q^{\prime}}{\ig} \\
   \vat{q^{\prime}}{\ih} \\
   \vat{q^{\prime}}{\ii}
\end{bmatrix},\end{split}\]</div>
<p>where the first matrix in the left-hand-side is the modified (i.e., periodic boundary) tri-diagonal matrix, which can be solved by the <a class="reference external" href="https://en.wikipedia.org/wiki/Tridiagonal_matrix_algorithm">tri-diagonal matrix algorithm</a> with <a class="reference external" href="https://en.wikipedia.org/wiki/Sherman–Morrison_formula">Sherman–Morrison formula</a>.
See <a class="reference internal" href="../linalg.html#linalg"><span class="std std-ref">src/linalg.c</span></a> for details.</p>
<p>Finally, the linear system is solved</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">457</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;=</span><span class="n">jtot</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">458</span><span class="w">        </span><span class="n">TDM_Q</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="linenos">459</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos">460</span><span class="w">      </span><span class="n">my_dgtsv_p</span><span class="p">(</span><span class="n">jtot</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_l</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_c</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_u</span><span class="p">,</span><span class="w"> </span><span class="n">tdm_q</span><span class="p">);</span><span class="w"></span>
<span class="linenos">461</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;=</span><span class="n">jtot</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">462</span><span class="w">        </span><span class="n">QY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TDM_Q</span><span class="p">(</span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="linenos">463</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>After all linear systems are solved, the <span class="math notranslate nohighlight">\(y\)</span>-aligned memory alignment is modified to the original <span class="math notranslate nohighlight">\(x\)</span>-aligned one by transposing the matrix again:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">475</span><span class="w">    </span><span class="n">parallel_transpose</span><span class="p">(</span><span class="n">jtot</span><span class="p">,</span><span class="w"> </span><span class="n">itot</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">qy</span><span class="p">,</span><span class="w"> </span><span class="n">qx</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</details></li>
<li><p>Update <span class="math notranslate nohighlight">\(\uy^k\)</span> to <span class="math notranslate nohighlight">\(\uy^*\)</span></p>
<details>
<summary>
Details</summary><p>Now the increment is ready, which is added to the velocity in <span class="math notranslate nohighlight">\(y\)</span> direction <code class="code highlight c-lang c docutils literal highlight-c"><span class="n">uy</span><span class="w"></span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">479</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;=</span><span class="n">jsize</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">480</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">itot</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">481</span><span class="w">      </span><span class="n">UY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">QX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="linenos">482</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">483</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</details></li>
</ol>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2022, Naoki Hori.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/implementation/fluid/update_velocity.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>